# TODO

## 1. GPT 支援網路搜尋功能

### 目標
讓機器人在回覆時可查詢最新資訊（例如新聞、天氣、時事、價格），再整合成自然語言回覆。

### 待辦
- [ ] 設計「是否需要搜尋」判斷流程（關鍵字或模型判斷）
- [ ] 實作搜尋工具層（可先用單一 provider，後續可抽換）
- [ ] 新增 `search(query)` service，回傳標題、摘要、來源連結、時間
- [ ] 在 OpenAI 對話流程中加入 tool-calling / function-calling
- [ ] 回覆內容中附上來源連結（至少 1~3 筆）
- [ ] 設定搜尋逾時、重試與 fallback（搜尋失敗時仍可一般回覆）
- [ ] 避免 prompt injection 與不可信來源內容直接執行
- [ ] 補上測試：
  - [ ] 需要即時資訊時會觸發搜尋
  - [ ] 不需要即時資訊時不觸發搜尋
  - [ ] 搜尋失敗時 fallback 正常

### 驗收標準
- [ ] 使用者問「今天/最新/最近」類問題時，回覆含可點擊來源
- [ ] 非即時問題不額外增加搜尋延遲
- [ ] 平均回覆時間在可接受範圍（可先訂 < 8 秒）

---

## 2. 排程改為資料庫驅動（輪詢提醒）

### 目標
把目前寫死在程式碼的 cron 任務改為 DB 管理，透過背景輪詢器執行提醒。

### 待辦
- [ ] 設計資料表：`reminder_jobs`（建議欄位）
  - [ ] `id`, `name`, `enabled`
  - [ ] `platform` (`line` / `discord`)
  - [ ] `target_id`（groupId / channelId）
  - [ ] `prompt`
  - [ ] `schedule_type`（cron/once/interval）
  - [ ] `cron_expr` / `run_at` / `interval_sec`
  - [ ] `timezone`
  - [ ] `last_run_at`, `next_run_at`
  - [ ] `created_at`, `updated_at`
- [ ] 設計執行紀錄表：`reminder_job_logs`
  - [ ] `job_id`, `run_at`, `status`, `error_message`, `response_preview`
- [ ] 實作 poller（例如每 30 秒輪詢一次）
- [ ] 加入分散式鎖/去重機制，避免多實例重複發送
- [ ] 任務執行成功後更新 `last_run_at` 與 `next_run_at`
- [ ] 任務失敗時寫入 log 並支援重試策略
- [ ] 新增管理 API（建立/更新/停用/刪除/查詢任務）
- [ ] 將 `routes/callGPTtime.js` 既有任務遷移為 DB seed
- [ ] 補上測試：
  - [ ] 到點會執行一次
  - [ ] 多實例不重複執行
  - [ ] 關閉任務不執行

### 驗收標準
- [ ] 新增任務後不需重啟服務即可生效
- [ ] 任務可在 DB/API 啟用、停用、修改排程
- [ ] 有完整執行紀錄可追蹤成功/失敗原因

---

## 優先順序建議
- [ ] P1：排程資料庫化（先解決維運與擴充性）
- [ ] P2：GPT 網路搜尋（提升回答即時性與準確度）

---

## 3. 使用者可在對話內直接新增排程提醒

### 目標
讓使用者在 LINE / Discord 對話中，用自然語言建立提醒，不需進後台手動設定。

### 待辦
- [ ] 設計對話指令格式（自然語言 + 可解析關鍵欄位）
- [ ] 實作提醒意圖辨識（新增提醒 / 修改提醒 / 取消提醒 / 查詢提醒）
- [ ] 實作時間解析（日期、星期、每天、每月、cron）
- [ ] 缺少必要資訊時，加入多輪追問（例如時間、頻道、提醒內容）
- [ ] 新增「確認步驟」：建立前先回顧設定，使用者確認後才寫入 DB
- [ ] 對接 `reminder_jobs`，建立任務時自動填入 `platform` 與 `target_id`
- [ ] 設定使用者權限（誰可在群組建立提醒）
- [ ] 新增防呆規則（過去時間、無效 cron、過高頻率）
- [ ] 支援列出目前提醒與刪除指定提醒（可用提醒 ID 或名稱）
- [ ] 補上測試：
  - [ ] 對話新增提醒成功
  - [ ] 缺欄位時可完成追問補齊
  - [ ] 取消/修改提醒流程正確
  - [ ] 未授權使用者無法建立群組提醒

### 驗收標準
- [ ] 使用者可用一句話建立提醒（例如：每週一早上9點提醒我報告）
- [ ] 建立前一定有確認訊息，避免誤建
- [ ] 建立成功後可在查詢清單中看到該提醒
- [ ] 提醒可準時被輪詢器觸發並發送

### 優先順序建議
- [ ] P1：完成「新增提醒 + 確認建立」
- [ ] P2：完成「查詢 / 修改 / 刪除提醒」

---

## 4. 對話記憶架構升級（4 層記憶）

### 目標
目前僅使用最近 12 筆訊息（短期記憶），升級為可組合的 4 層記憶架構：

1. `systemPrompt`
2. `user_profile`（長期記憶，從 DB 讀取）
3. `conversation_summary`（對話摘要，從 DB 讀取且可更新）
4. `last_messages`（短期記憶，最近 12 筆）

### 待辦
- [ ] 設計最終送給模型的 prompt 組裝順序與格式（固定 1→2→3→4）
- [ ] 建立/擴充資料表以儲存 `user_profile`（可依 userId 維護偏好、背景、語言）
- [ ] 建立/擴充資料表以儲存 `conversation_summary`（可依 convId 維護）
- [ ] 實作 `user_profile` 讀取層（查無資料時 fallback）
- [ ] 實作 `conversation_summary` 讀取層（查無摘要時 fallback）
- [ ] 實作摘要更新機制（例如每 N 則訊息或 token 超過門檻時重寫摘要）
- [ ] 設計摘要更新策略（覆寫式 / 增量式）與長度上限
- [ ] 在 `chatWithOpenAI` 流程注入四層記憶
- [ ] 加入安全規則：`systemPrompt` 不可被使用者覆蓋
- [ ] 補上測試：
  - [ ] prompt 組裝順序正確
  - [ ] 無 `user_profile` / `conversation_summary` 時可正常回覆
  - [ ] 摘要更新後，下次對話可正確讀到新摘要

### 驗收標準
- [ ] 模型每次回覆皆使用 4 層記憶（有資料則帶入，無資料則安全 fallback）
- [ ] 回覆品質在長對話中更穩定，不只依賴最近 12 筆
- [ ] `conversation_summary` 可持續更新且可追蹤最後更新時間

### 優先順序建議
- [ ] P1：先完成讀取與組裝（systemPrompt + user_profile + summary + last_messages）
- [ ] P2：完成摘要自動更新策略
